<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>All Users | EAI Microservices</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <div id="navbarContainer"></div>

  <div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3><i class="fas fa-users me-2"></i>All Users</h3>
    </div>

    <div id="userList" class="table-responsive">
      <table class="table table-bordered table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="userTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal Edit User -->
  <div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
      <form class="modal-content" id="editUserForm">
        <div class="modal-header">
          <h5 class="modal-title">Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editUserId">
          <div class="mb-3">
            <label class="form-label">Full Name</label>
            <input type="text" class="form-control" id="editName" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="editEmail" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Phone</label>
            <input type="text" class="form-control" id="editPhone">
          </div>
          <div class="mb-3">
            <label class="form-label">Password (isi jika ingin diubah)</label>
            <input type="password" class="form-control" id="editPassword">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const token = localStorage.getItem("token");
      if (!token) return window.location.href = "index.html";

      const userTableBody = document.getElementById("userTableBody");
      const editUserForm = document.getElementById("editUserForm");
      const editUserModal = new bootstrap.Modal(document.getElementById("editUserModal"));

      async function loadUsers() {
        const res = await fetch("http://localhost:3001/users", {
          headers: { Authorization: "Bearer " + token }
        });
        const users = await res.json();

        userTableBody.innerHTML = users.map(user => `
          <tr>
            <td>${user.id}</td>
            <td>${user.name}</td>
            <td>${user.email}</td>
            <td>${user.phone || '-'}</td>
            <td>
              <button class="btn btn-sm btn-warning me-1" onclick="editUser(${user.id}, '${user.name}', '${user.email}', '${user.phone}')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `).join('');
      }

      window.editUser = (id, name, email, phone) => {
        document.getElementById("editUserId").value = id;
        document.getElementById("editName").value = name;
        document.getElementById("editEmail").value = email;
        document.getElementById("editPhone").value = phone || '';
        document.getElementById("editPassword").value = '';
        editUserModal.show();
      };

      editUserForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = document.getElementById("editUserId").value;
        const name = document.getElementById("editName").value;
        const email = document.getElementById("editEmail").value;
        const phone = document.getElementById("editPhone").value;
        const password = document.getElementById("editPassword").value;

        const body = { name, email, phone };
        if (password) body.password = password;

        const res = await fetch(`http://localhost:3001/users/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
          },
          body: JSON.stringify(body)
        });

        if (res.ok) {
          alert("User updated!");
          editUserForm.reset();
          editUserModal.hide();
          loadUsers();
        } else {
          alert("Update failed.");
        }
      });

      window.deleteUser = async (id) => {
        if (!confirm("Are you sure want to delete this user?")) return;
        const res = await fetch(`http://localhost:3001/users/${id}`, {
          method: "DELETE",
          headers: { Authorization: "Bearer " + token }
        });
        if (res.ok) {
          loadUsers();
        } else {
          alert("Failed to delete user.");
        }
      };

      window.logout = () => {
        localStorage.clear();
        window.location.href = "index.html";
      };

      loadUsers();
    });
  </script>
  <script>
    fetch('navbar.html')
      .then(res => res.text())
      .then(data => {
        document.getElementById('navbarContainer').innerHTML = data;
      })
      .catch(error => {
        console.error('Failed to load navbar:', error);
        document.getElementById('navbarContainer').innerHTML = 
          '<div class="alert alert-danger">Failed to load navigation. Please refresh the page.</div>';
      });
  </script>
</body>
</html>
